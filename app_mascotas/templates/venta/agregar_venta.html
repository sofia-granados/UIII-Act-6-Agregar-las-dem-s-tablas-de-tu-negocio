{% extends "base.html" %}
{% block content %}
<div class="card card-soft p-4">
  <h4 class="text-pet-primary mb-4">
    <i class="bi bi-cart-plus me-2"></i>Registrar Nueva Venta
  </h4>
  
  <form method="POST">
    {% csrf_token %}
    
    <div class="row">
      <div class="col-md-6 mb-3">
        <label class="form-label">Empleado:</label>
        <select name="empleado" class="form-select" required>
          <option value="">Seleccione un empleado</option>
          {% for e in empleados %}
            <option value="{{ e.id_empleado }}">{{ e.nombre }} {{ e.apepaterno }} - {{ e.puesto }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-6 mb-3">
        <label class="form-label">Cliente:</label>
        <select name="cliente" class="form-select" required>
          <option value="">Seleccione un cliente</option>
          {% for c in clientes %}
            <option value="{{ c.id_cliente }}">{{ c.nombre }} {{ c.apepaterno }} {{ c.apematerno }}</option>
          {% endfor %}
        </select>
      </div>
    </div>

    <div class="mb-3">
      <label class="form-label">Fecha de Venta:</label>
      <input type="datetime-local" name="fecha_venta" class="form-control" required>
    </div>

    <div class="card bg-light p-3 mb-3">
      <h6 class="text-pet-primary mb-3">
        <i class="bi bi-bag me-2"></i>Productos de la Venta
      </h6>
      
      <div id="productos-container">
        <div class="row producto-item mb-3">
          <div class="col-md-6">
            <label class="form-label">Producto:</label>
            <select name="productos" class="form-select producto-select" required>
              <option value="">Seleccione un producto</option>
              {% for p in productos %}
                <option value="{{ p.id_producto }}" data-precio="{{ p.precio }}">
                  {{ p.nombre }} - ${{ p.precio }} (Stock: {{ p.stock }})
                </option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Cantidad:</label>
            <input type="number" name="cantidades" class="form-control cantidad-input" min="1" value="1" required>
          </div>
          <div class="col-md-2">
            <label class="form-label">Precio:</label>
            <input type="text" class="form-control precio-display" readonly value="$0.00">
          </div>
        </div>
      </div>

      <button type="button" id="agregar-producto" class="btn btn-outline-primary btn-sm">
        <i class="bi bi-plus-circle me-1"></i>Agregar otro producto
      </button>
    </div>

    <div class="card bg-success text-white p-3 mb-4">
      <div class="row">
        <div class="col-md-6">
          <h6 class="mb-0">Total de la Venta:</h6>
        </div>
        <div class="col-md-6 text-end">
          <h4 class="mb-0" id="total-venta">$0.00</h4>
        </div>
      </div>
    </div>

    <div class="d-flex gap-2">
      <button type="submit" class="btn btn-primary">
        <i class="bi bi-check-circle me-2"></i>Registrar Venta
      </button>
      <a href="{% url 'ver_ventas' %}" class="btn btn-secondary">
        <i class="bi bi-x-circle me-2"></i>Cancelar
      </a>
    </div>
  </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const productosContainer = document.getElementById('productos-container');
  const agregarProductoBtn = document.getElementById('agregar-producto');
  const totalVenta = document.getElementById('total-venta');

  // FunciÃ³n para actualizar el total
  function actualizarTotal() {
    let total = 0;
    const productoItems = document.querySelectorAll('.producto-item');
    
    productoItems.forEach(item => {
      const precio = parseFloat(item.querySelector('.producto-select').selectedOptions[0]?.dataset.precio || 0);
      const cantidad = parseInt(item.querySelector('.cantidad-input').value || 0);
      const subtotal = precio * cantidad;
      
      item.querySelector('.precio-display').value = `$${subtotal.toFixed(2)}`;
      total += subtotal;
    });
    
    totalVenta.textContent = `$${total.toFixed(2)}`;
  }

  // Event listeners para cambios en productos y cantidades
  productosContainer.addEventListener('change', function(e) {
    if (e.target.classList.contains('producto-select') || e.target.classList.contains('cantidad-input')) {
      actualizarTotal();
    }
  });

  productosContainer.addEventListener('input', function(e) {
    if (e.target.classList.contains('cantidad-input')) {
      actualizarTotal();
    }
  });

  // Agregar nuevo producto
  agregarProductoBtn.addEventListener('click', function() {
    const nuevoProducto = document.querySelector('.producto-item').cloneNode(true);
    nuevoProducto.querySelector('.producto-select').value = '';
    nuevoProducto.querySelector('.cantidad-input').value = 1;
    nuevoProducto.querySelector('.precio-display').value = '$0.00';
    productosContainer.appendChild(nuevoProducto);
    actualizarTotal();
  });

  // Inicializar total
  actualizarTotal();
});
</script>

<style>
.precio-display {
  background-color: #f8f9fa;
  font-weight: bold;
}
</style>
{% endblock %}